<project>
	<shortName>OpenForisCollect</shortName>
	<fullName>Open Foris Collect</fullName>
	<version>VERSION_ID</version>
	<vendor>Open Foris</vendor>

	<!-- <readmeFile>../../../README</readmeFile> <licenseFile>../../../../License.txt</licenseFile> -->
	<logoImage>images/of-collect-logo-small.png</logoImage>
	<componentList>
		<component>
			<name>default</name>
			<description>Default Component</description>
			<canBeEdited>1</canBeEdited>
			<selected>1</selected>
			<show>1</show>
			<desktopShortcutList>
				<shortcut>
					<name>Update Open Foris Collect</name>
					<comment>Update Open Foris Collect</comment>
					<exec>${installdir}/autoupdate/autoupdate-linux.run</exec>
					<path>${installdir}/autoupdate</path>
					<icon>${installdir}/images/update.png</icon>
					<platforms>linux</platforms>
					<runAsAdmin>0</runAsAdmin>
					<runInTerminal>0</runInTerminal>
					<windowsExec></windowsExec>
					<windowsExecArgs></windowsExecArgs>
					<windowsIcon></windowsIcon>
					<windowsPath></windowsPath>
				</shortcut>
			</desktopShortcutList>
			<folderList>
				<folder>
					<name>programfiles</name>
					<description>Program Files</description>
					<destination>${installdir}</destination>
					<platforms>all</platforms>
					<distributionFileList>
						<distributionDirectory>
							<origin>libs</origin>
						</distributionDirectory>
						<distributionDirectory>
							<origin>webapps</origin>
						</distributionDirectory>
						<distributionFile>
							<allowWildcards>1</allowWildcards>
							<origin>images</origin>
						</distributionFile>
						<distributionFile>
							<allowWildcards>1</allowWildcards>
							<origin>collect.properties</origin>
						</distributionFile>
					</distributionFileList>
				</folder>
			</folderList>
			<startMenuShortcutList>
				<startMenuShortcut>
					<name>Update Open Foris Collect</name>
					<comment>Update Open Foris Collect</comment>
					<runAsAdmin>0</runAsAdmin>
					<runInTerminal>0</runInTerminal>
					<windowsExec>${installdir}/autoupdate/autoupdate-windows.exe</windowsExec>
					<windowsExecArgs></windowsExecArgs>
					<windowsIcon>${installdir}/images/update.ico</windowsIcon>
				</startMenuShortcut>
			</startMenuShortcutList>
		</component>
		<component>
			<name>autoupdater</name>
			<description>includes tool to perform updates</description>
			<canBeEdited>0</canBeEdited>
			<selected>1</selected>
			<show>0</show>
			<folderList>
				<folder>
					<name>autoupdaterwin</name>
					<destination>${installdir}/autoupdate</destination>
					<platforms>windows</platforms>
					<distributionFileList>
						<distributionFile origin="autoupdate-windows.exe" />
					</distributionFileList>
				</folder>
				<folder>
					<name>autoupdaterlinux</name>
					<destination>${installdir}/autoupdate</destination>
					<platforms>linux</platforms>
					<distributionFileList>
						<distributionFile origin="autoupdate-linux.run" />
					</distributionFileList>
				</folder>
				<folder>
					<name>autoupdaterosx</name>
					<destination>${installdir}/autoupdate</destination>
					<platforms>osx</platforms>
					<distributionFileList>
						<distributionFile origin="autoupdate-osx.app.zip" />
					</distributionFileList>
				</folder>
			</folderList>
			<postInstallationActionList>
				<createDirectory>
					<path>${installdir}/autoupdate</path>
				</createDirectory>
				<writeFile>
					<path>${installdir}/autoupdate/update.ini</path>
					<text>[Update]
url = UPDATE_XML_URL
version_id = VERSION_ID
update_download_location = ${system_temp_directory}
check_for_updates = 1</text>
				</writeFile>
				<!-- Create Data folder -->
				<createDirectory>
					<path>${data_dir}</path>
				</createDirectory>
				<createDirectory>
					<path>${logs_dir}</path>
				</createDirectory>
				<!-- Find free http port -->
		        <getFreePort>
		            <finalPort>8399</finalPort>
		            <initialPort>8380</initialPort>
		            <variable>http_port</variable>
		        </getFreePort>
		        <!-- Write the ports configuration in collect.properties file -->
		        <propertiesFileSet>
		        	<file>${installdir}/collect.properties</file>
		        	<key>http_port</key>
		        	<value>${http_port}</value>
		        </propertiesFileSet>
			</postInstallationActionList>
		</component>
		<include>
			<file>java.xml</file>
		</include>
	</componentList>
	<preInstallationActionList>
		<throwError>
			<explanation>Open Foris Collect has been already installed</explanation>
			<text>Open Foris Collect has been already installed. Please run Update Open Foris Collect if you want to update it.</text>
			<ruleEvaluationLogic>and</ruleEvaluationLogic>
			<ruleList>
				<fileTest path="${installdir}" condition="exists" />
				<fileTest path="${installdir}" condition="is_not_empty" />
			</ruleList>
        </throwError>
		<if>
        	<actionList>
        		<setInstallerVariable>
        			<name>installdir</name>
        			<value>${env(SYSTEMDRIVE)}/OpenForis/Collect</value> 
        		</setInstallerVariable>
        	</actionList>
        	<conditionRuleList>
        		<platformTest>
        			<type>windows</type>
        		</platformTest>
			</conditionRuleList> 
			<elseActionList>
				<setInstallerVariable>
					<name>installdir</name>
					<value>~/OpenForis/Collect</value>
				</setInstallerVariable>
			</elseActionList>
		</if>
		<setInstallerVariable>
			<name>root_user_dir</name>
			<value>${user_home_directory}/OpenForis/Collect</value>
		</setInstallerVariable>
		<setInstallerVariable>
			<name>data_dir</name>
			<value>${root_user_dir}/data</value>
		</setInstallerVariable>
		<setInstallerVariable>
			<name>logs_dir</name>
			<value>${root_user_dir}/logs</value>
		</setInstallerVariable>
		<setInstallerVariable>
			<name>java_launcher_mainClass</name>
			<value>org.openforis.collect.controlpanel.CollectControlPanel</value>
		</setInstallerVariable>
		<setInstallerVariable>
			<name>java_launcher_classpath</name>
			<value>libs/*;</value>
		</setInstallerVariable>
	</preInstallationActionList>
	<postInstallationActionList>
		<changePermissions>
			<files>${installdir}/autoupdate/*.run</files>
			<permissions>0775</permissions>
		</changePermissions>
		<changeOwnerAndGroup>
			<files>/home/${env(SUDO_USER)}/Desktop/${java_launcher_binary_name}
			</files>
			<group></group>
			<owner>${env(SUDO_USER)}</owner>
			<ruleList>
				<platformTest>
					<type>linux</type>
				</platformTest>
			</ruleList>
		</changeOwnerAndGroup>
		<!-- delete temporary files (if any, from previous installations) -->
        <deleteFile>
  			<path>${installdir}/webapps/collect</path>
			<abortOnError>0</abortOnError>
		</deleteFile>
	</postInstallationActionList>
	<postUninstallationActionList>
		<deleteFile>
			<path>${project.rollbackBackupDirectory}</path>
		</deleteFile>
	</postUninstallationActionList>
	<compressionAlgorithm>lzma-ultra</compressionAlgorithm>
	<defaultUnixDirectoryPermissions>777</defaultUnixDirectoryPermissions>
	<defaultUnixFilePermissions>777</defaultUnixFilePermissions>
	<defaultUnixOwner>${env(SUDO_USER)}</defaultUnixOwner>
	<enableRollback>1</enableRollback>
	<enableTimestamp>1</enableTimestamp>
	<rebootRequired>0</rebootRequired>
	<requireInstallationByRootUser>0</requireInstallationByRootUser>
	<requestedExecutionLevel>asInvoker</requestedExecutionLevel>
	<rollbackBackupDirectory>${system_temp_directory}/${product_shortname}/backup</rollbackBackupDirectory>
	<saveRelativePaths>1</saveRelativePaths>
	<createOsxBundleDmg>1</createOsxBundleDmg>
	<parameterList>
		<directoryParameter>
			<name>installdir</name>
			<description>Installer.Parameter.installdir.description</description>
			<explanation>Installer.Parameter.installdir.explanation</explanation>
			<value></value>
			<default>${platform_install_prefix}/${product_shortname}</default>
			<allowEmptyValue>0</allowEmptyValue>
			<cliOptionName>prefix</cliOptionName>
			<mustBeWritable>1</mustBeWritable>
			<mustExist>0</mustExist>
			<width>30</width>
		</directoryParameter>
	</parameterList>
</project>

