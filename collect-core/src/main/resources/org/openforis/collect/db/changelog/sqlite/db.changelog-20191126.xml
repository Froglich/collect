<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<changeSet id="change-code-list-id-data-type" author="ricci" dbms="sqlite">
		<comment>Change code list id data type</comment>
		
		<!-- Rename old table into _temp -->
		<sql>
			ALTER TABLE ofc_code_list RENAME TO ofc_code_list_temp;
		</sql>

		<!-- Create new table ofc_code_list-->
		<createTable tableName="ofc_code_list">
			<column name="id" type="bigint">
				<constraints nullable="false" primaryKey="true"
					primaryKeyName="ofc_code_list_pkey" />
			</column>
			<column name="survey_id" type="INTEGER" />
			<column name="code_list_id" type="INTEGER">
				<constraints nullable="false" />
			</column>
			<column name="item_id" type="INTEGER">
				<constraints nullable="false" />
			</column>
			<column name="parent_id" type="bigint" />
			<column name="sort_order" type="INTEGER">
				<constraints nullable="false" />
			</column>
			<column name="code" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="qualifiable" type="BOOLEAN" />
			<column name="since_version_id" type="INTEGER" />
			<column name="deprecated_version_id" type="INTEGER" />
			<column name="label1" type="VARCHAR(255)" />
			<column name="label2" type="VARCHAR(255)" />
			<column name="label3" type="VARCHAR(255)" />
			<column name="label4" type="VARCHAR(255)" />
			<column name="label5" type="VARCHAR(255)" />
			<column name="description1" type="VARCHAR(1023)" />
			<column name="description2" type="VARCHAR(1023)" />
			<column name="description3" type="VARCHAR(1023)" />
			<column name="description4" type="VARCHAR(1023)" />
			<column name="description5" type="VARCHAR(1023)" />
			<column name="level" type="INTEGER" />
			<column name="image_content" type="bytea" />
			<column name="image_file_name" type="VARCHAR(255)" />
			<column name="color" type="char(6)" />
		</createTable>

		<!-- Copy values from _temp table into new one -->
		<sql>
			INSERT INTO ofc_code_list
			SELECT 
			
			id, survey_id, code_list_id, item_id, parent_id, 
			sort_order, code, qualifiable,
			since_version_id, deprecated_version_id, 
			label1, label2, label3, label4, label5,
			description1, description2, description3, description4, description5,
			level, image_content, image_file_name, color
			
			FROM ofc_code_list_temp;
			
			DROP TABLE ofc_code_list_temp;
		</sql>
		
		<!-- Create indexes -->
		<createIndex indexName="ofc_code_list_survey_idx"
			tableName="ofc_code_list">
			<column name="survey_id" type="INTEGER" />
		</createIndex>

		<createIndex indexName="ofc_code_list_parent_id_idx"
			tableName="ofc_code_list">
			<column name="parent_id" type="INTEGER" />
		</createIndex>

		<createIndex indexName="ofc_code_list_child_items_idx"
			tableName="ofc_code_list">
			<column name="survey_id" type="INTEGER" />
			<column name="code_list_id" type="INTEGER" />
			<column name="parent_id" type="INTEGER" />
		</createIndex>

		<createIndex indexName="ofc_code_list_child_item_idx"
			tableName="ofc_code_list" unique="true">
			<column name="survey_id" type="INTEGER" />
			<column name="code_list_id" type="INTEGER" />
			<column name="parent_id" type="INTEGER" />
			<column name="code" type="VARCHAR(255)" />
		</createIndex>
		
	</changeSet>

</databaseChangeLog>